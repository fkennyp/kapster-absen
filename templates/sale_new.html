{% extends 'base.html' %}
{% block title %}Transaksi Baru{% endblock %}
{% block content %}
<div class="sale-form-container">
    <div class="sale-form">
        <h1>Transaksi Baru</h1>

        <!-- FLASH MESSAGE AREA -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container" style="position:sticky; top:0; z-index:1030; margin-bottom:12px;">
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
                role="alert">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="post" class="form" id="saleForm">
            <!-- Customer Information -->
            <div class="card">
                <h3>Data Pelanggan</h3>

                <div class="form-group phone-group-rel">
                    <label for="customer_phone">
                        Nomor Telepon (Opsional, untuk menjadi member)
                        <button type="button" tabindex="-1" class="help-btn" onclick="togglePhoneHelp()" onmouseenter="showPhoneHelp()">
                            <span class="help-btn-circle">?</span>
                        </button>
                    </label>
                    <input id="customer_phone" name="customer_phone" type="tel" placeholder="08xxxxxxxxxx"
                        autocomplete="off">
                    <div id="phoneDropdown" class="autocomplete-dropdown"></div>
                    <div id="phoneHelpTooltip" class="phone-help-tooltip">
                        <strong>Fungsi Nomor Telepon:</strong><br>
                        - Jika diisi dengan nomor pelanggan yang sudah pernah terdaftar, nama pelanggan akan otomatis terisi.<br>
                        - Jika nomor baru, isi nama pelanggan secara manual.<br>
                        - Nomor telepon digunakan untuk keanggotaan/member.<br>
                        <em>Kolom ini opsional, tapi sangat disarankan diisi jika pelanggan ingin menjadi member atau sudah pernah bertransaksi sebelumnya.</em>
                    </div>
                </div>

                <div class="form-group">
                    <label for="customer_name">Nama Pelanggan *</label>
                    <input type="text" name="customer_name" id="customer_name" required
                        placeholder="Masukkan nama lengkap pelanggan" autocomplete="off">
                    <span id="nameError" class="error-message">Nama pelanggan wajib diisi</span>
                </div>

                <div class="form-group">
                    <label for="customer_email">Alamat Email (Opsional, untuk mengirimkan nota)</label>
                    <input id="customer_email" name="customer_email" type="email" placeholder="contoh@email.com">
                    <span id="emailError" class="error-message">Format alamat email tidak valid</span>
                </div>
            </div>

            <!-- Services Selection -->
            <div class="card">
                <h3>Pilih Layanan</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Layanan</th>
                            <th>Harga</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in services %}
                        <tr>
                            <td>{{ s.name }}</td>
                            <td>Rp {{ "{:,}".format(s.price) }}</td>
                            <td>
                                <input type="hidden" name="service_id" value="{{ s.id }}">
                                <div class="qty-wrap" data-price="{{ s.price }}">
                                    <button type="button" class="qty-btn" onclick="decQty(this)">âˆ’</button>
                                    <input class="qty-input" type="number" min="0" name="qty" value="0" readonly style="background:#fff; color:#222; width:40px; text-align:center; font-weight:600; border:1px solid #d1d5db; border-radius:6px;">
                                    <button type="button" class="qty-btn" onclick="incQty(this)">+</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Payment Information -->
            <div class="card">

                <h3>Informasi Pembayaran</h3>

                <div class="form-group">
                    <label for="discount">Diskon</label>
                    <select name="discount" id="discount">
                        <option value="" data-type="none" data-value="0">Tanpa Diskon</option>
                        {% for d in discounts %}
                        <option value="{{ d.id }}" data-type="{{ d.discount_type }}" data-value="{{ d.value }}">
                            {{ d.name }} - {% if d.discount_type == 'nominal' %}Rp {{ '{:,}'.format(d.value) }}{% else
                            %}{{ d.value }}%{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="payType">Tipe Pembayaran</label>
                    <select name="payment_type" id="payType" onchange="toggleCash()">
                        <option value="cash">Cash</option>
                        <option value="qris">QRIS</option>
                    </select>
                </div>

                <div id="cashWrap">
                    <div class="form-group">
                        <label for="cashGiven">Jumlah Dibayarkan</label>
                        <input type="number" name="cash_given" id="cashGiven" min="0"
                            placeholder="Masukkan jumlah pembayaran">
                        <span id="cashError" class="error-message">Jumlah yang dibayarkan masih kurang dari total</span>
                    </div>
                </div>

                <div class="total-display">
                    <div class="total-amount">
                        <strong>Subtotal: Rp <span id="subtotal">0</span></strong><br>
                        <span id="discountRow" style="display:none;">Diskon: -Rp <span
                                id="discountShow">0</span></span><br>
                        <strong>Total Setelah Diskon: Rp <span id="total">0</span></strong>
                    </div>
                    <div id="changeWrap">
                        <strong>Kembalian: Rp <span id="change">0</span></strong>
                    </div>
                </div>
            </div>

            <button type="submit" id="submitBtn" disabled>Simpan & Unduh Nota</button>
        </form>
    </div>
</div>

<script type="text/javascript">
    // --- Phone Autocomplete Dropdown from Master Customer ---
    document.addEventListener('DOMContentLoaded', function () {
        const phoneInput = document.getElementById('customer_phone');
        const nameInput = document.getElementById('customer_name');
        const dropdown = document.getElementById('phoneDropdown');
        let lastPhones = [];
        let selectedCustomer = null;

        function setCustomerNameFromPhone(phone) {
            if (!phone || phone.length < 3) {
                nameInput.value = '';
                nameInput.readOnly = false;
                selectedCustomer = null;
                return;
            }
            fetch(`/admin/customers?q=${encodeURIComponent(phone)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.customers && data.customers.length > 0) {
                        // Find exact match
                        const found = data.customers.find(c => c.phone === phone);
                        if (found) {
                            nameInput.value = found.name;
                            nameInput.readOnly = true;
                            selectedCustomer = found;
                        } else {
                            nameInput.value = '';
                            nameInput.readOnly = false;
                            selectedCustomer = null;
                        }
                    } else {
                        nameInput.value = '';
                        nameInput.readOnly = false;
                        selectedCustomer = null;
                    }
                });
        }

        phoneInput.addEventListener('input', function () {
            const q = phoneInput.value.trim();
            if (q.length < 3) {
                dropdown.style.display = 'none';
                dropdown.innerHTML = '';
                nameInput.value = '';
                nameInput.readOnly = false;
                selectedCustomer = null;
                return;
            }
            fetch(`/admin/customers?q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(data => {
                    if (!data.customers || !data.customers.length) {
                        dropdown.style.display = 'none';
                        dropdown.innerHTML = '';
                        nameInput.value = '';
                        nameInput.disabled = false;
                        selectedCustomer = null;
                        return;
                    }
                    lastPhones = data.customers;
                    dropdown.innerHTML = '';
                    data.customers.forEach(cust => {
                        const opt = document.createElement('div');
                        opt.textContent = `${cust.name} (${cust.phone})`;
                        opt.style.padding = '8px 12px';
                        opt.style.cursor = 'pointer';
                        opt.addEventListener('mousedown', function (ev) {
                            ev.preventDefault();
                            phoneInput.value = cust.phone;
                            nameInput.value = cust.name;
                            nameInput.readOnly = true;
                            selectedCustomer = cust;
                            dropdown.style.display = 'none';
                            dropdown.innerHTML = '';
                        });
                        dropdown.appendChild(opt);
                    });
                    // Position dropdown below input (relative to parent)
                    dropdown.style.left = '0';
                    dropdown.style.top = (phoneInput.offsetTop + phoneInput.offsetHeight) + 'px';
                    dropdown.style.width = phoneInput.offsetWidth + 'px';
                    dropdown.style.display = 'block';
                });
        });
        phoneInput.addEventListener('blur', function () {
            setTimeout(() => { dropdown.style.display = 'none'; }, 150);
            // On blur, check if phone is registered and set name field accordingly
            setTimeout(() => {
                setCustomerNameFromPhone(phoneInput.value.trim());
            }, 200);
        });
        // Also, on page load, if phone is prefilled, check
        setCustomerNameFromPhone(phoneInput.value.trim());
    });
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Hide all error messages initially
        document.getElementById('nameError').style.display = 'none';
        document.getElementById('emailError').style.display = 'none';
        document.getElementById('cashError').style.display = 'none';

        toggleCash();
        recalc();
    });

    function getQtyWraps() {
        return Array.from(document.querySelectorAll('.qty-wrap'));
    }

    function incQty(btn) {
        const wrap = btn.closest('.qty-wrap');
        const input = wrap.querySelector('.qty-input');
        const currentValue = parseInt(input.value) || 0;
        input.value = currentValue + 1;
        recalc();
    }

    function decQty(btn) {
        const wrap = btn.closest('.qty-wrap');
        const input = wrap.querySelector('.qty-input');
        const currentValue = parseInt(input.value) || 0;
        input.value = Math.max(0, currentValue - 1);
        recalc();
    }

    function totalCalc() {
        let total = 0;
        getQtyWraps().forEach(wrap => {
            const price = parseInt(wrap.dataset.price) || 0;
            const qtyInput = wrap.querySelector('.qty-input');
            const qty = parseInt(qtyInput.value) || 0;
            if (qty > 0) {
                total += price * qty;
            }
        });
        return total;
    }


    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function recalc() {
        const subtotal = totalCalc();
        document.getElementById('subtotal').textContent = subtotal.toLocaleString('id-ID');

        // Diskon dari dropdown
        const discountSelect = document.getElementById('discount');
        const selectedOpt = discountSelect.options[discountSelect.selectedIndex];
        const discountType = selectedOpt.getAttribute('data-type');
        const discountValue = parseInt(selectedOpt.getAttribute('data-value')) || 0;
        let discount = 0;
        if (discountType === 'persen') {
            discount = Math.floor(subtotal * discountValue / 100);
        } else if (discountType === 'nominal') {
            discount = discountValue;
        } else {
            discount = 0;
        }
        if (discount < 0) discount = 0;
        if (discount > subtotal) discount = subtotal;

        // Tampilkan baris diskon jika ada
        const discountRow = document.getElementById('discountRow');
        const discountShow = document.getElementById('discountShow');
        if (discount > 0) {
            discountRow.style.display = 'inline';
            discountShow.textContent = discount.toLocaleString('id-ID');
        } else {
            discountRow.style.display = 'none';
            discountShow.textContent = '0';
        }

        const total = subtotal - discount;
        document.getElementById('total').textContent = total.toLocaleString('id-ID');

        const payType = document.getElementById('payType').value;
        const submitBtn = document.getElementById('submitBtn');
        const nameVal = document.getElementById('customer_name').value.trim();
        const emailVal = document.getElementById('customer_email').value.trim();

        let isValid = true;

        // Validasi nama pelanggan (wajib)
        const nameError = document.getElementById('nameError');
        if (!nameVal) {
            nameError.style.display = 'block';
            nameError.textContent = 'Nama pelanggan harus diisi';
            isValid = false;
        } else {
            nameError.style.display = 'none';
        }

        // Validasi email (opsional, tapi jika diisi harus valid)
        const emailError = document.getElementById('emailError');
        if (emailVal) {
            if (!validateEmail(emailVal)) {
                emailError.style.display = 'block';
                emailError.textContent = 'Format email tidak valid. Contoh: nama@email.com';
                isValid = false;
            } else {
                emailError.style.display = 'none';
            }
        } else {
            emailError.style.display = 'none';
        }

        // Validasi cash payment
        const cashError = document.getElementById('cashError');
        const changeWrap = document.getElementById('changeWrap');

        if (payType === 'cash') {
            const cashGiven = parseInt(document.getElementById('cashGiven').value) || 0;
            const change = cashGiven - total;

            document.getElementById('change').textContent = Math.max(0, change).toLocaleString('id-ID');

            if (cashGiven <= 0) {
                cashError.style.display = 'block';
                cashError.textContent = 'Jumlah pembayaran harus diisi';
                isValid = false;
            } else if (cashGiven < total) {
                cashError.style.display = 'block';
                cashError.textContent = `Jumlah yang dibayarkan kurang dari total (Rp ${total.toLocaleString('id-ID')})`;
                isValid = false;
            } else {
                cashError.style.display = 'none';
            }
            changeWrap.style.display = 'block';
        } else {
            cashError.style.display = 'none';
            changeWrap.style.display = 'none';
        }

        // Validasi minimal 1 layanan dipilih
        if (subtotal === 0) {
            isValid = false;
        }

        // Enable/disable submit button
        submitBtn.disabled = !isValid;

        // Visual feedback untuk button
        if (isValid) {
            submitBtn.style.backgroundColor = '#111827';
            submitBtn.style.cursor = 'pointer';
        } else {
            submitBtn.style.backgroundColor = '#9ca3af';
            submitBtn.style.cursor = 'not-allowed';
        }
    }

    function toggleCash() {
        const payType = document.getElementById('payType').value;
        const cashWrap = document.getElementById('cashWrap');
        const changeWrap = document.getElementById('changeWrap');

        if (payType === 'cash') {
            cashWrap.style.display = 'block';
            changeWrap.style.display = 'block';
        } else {
            cashWrap.style.display = 'none';
            changeWrap.style.display = 'none';
            // Reset cash field when not cash payment
            document.getElementById('cashGiven').value = '';
        }
        recalc();
    }

    // Real-time validation
    document.getElementById('customer_name').addEventListener('input', recalc);
    document.getElementById('customer_email').addEventListener('input', recalc);
    document.getElementById('cashGiven').addEventListener('input', recalc);
    document.getElementById('discount').addEventListener('change', recalc);

    // Validasi saat form submit (additional safety)
    document.getElementById('saleForm').addEventListener('submit', function (e) {
        recalc();
        if (document.getElementById('submitBtn').disabled) {
            e.preventDefault();
            alert('Harap perbaiki error sebelum melanjutkan.');
        }
    });
</script>
<script type="text/javascript">
    // Tooltip logic for phone help
    const helpBtn = document.querySelector('.help-btn');
    const helpTooltip = document.getElementById('phoneHelpTooltip');
    let helpTooltipManual = false;
    if (helpBtn && helpTooltip) {
        helpBtn.addEventListener('mouseenter', function () {
            if (!helpTooltipManual) helpTooltip.style.display = 'block';
        });
        helpBtn.addEventListener('mouseleave', function () {
            if (!helpTooltipManual) helpTooltip.style.display = 'none';
        });
        helpBtn.addEventListener('click', function () {
            helpTooltipManual = !helpTooltipManual;
            helpTooltip.style.display = helpTooltipManual ? 'block' : 'none';
        });
        // Hide tooltip if clicked outside
        document.addEventListener('click', function (e) {
            if (helpTooltipManual && !helpBtn.contains(e.target) && !helpTooltip.contains(e.target)) {
                helpTooltipManual = false;
                helpTooltip.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}