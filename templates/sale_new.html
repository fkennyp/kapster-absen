{% extends 'base.html' %}
{% block title %}Transaksi Baru{% endblock %}
{% block content %}
<div class="sale-form-container">
    <div class="sale-form">
        <h1>Transaksi Baru</h1>
        
        <!-- FLASH MESSAGE AREA -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-container" style="position:sticky; top:0; z-index:1030; margin-bottom:12px;">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form method="post" class="form" id="saleForm">
            <!-- Customer Information -->
            <div class="card">
                <h3>Informasi Pelanggan</h3>
                
                <div class="form-group">
                    <label for="customer_name">Nama Pelanggan *</label>
                    <input type="text" name="customer_name" id="customer_name" required 
                           placeholder="Masukkan nama pelanggan">
                    <span id="nameError" class="error-message">Nama harus diisi</span>
                </div>

                <div class="form-group">
                    <label for="customer_email">Email Customer (opsional, nota dikirim email)</label>
                    <input id="customer_email" name="customer_email" type="email" 
                           placeholder="nama@email.com">
                    <span id="emailError" class="error-message">Format email tidak valid</span>
                </div>

                <div class="form-group">
                    <label for="customer_phone">No. HP (opsional, untuk jadi member)</label>
                    <input id="customer_phone" name="customer_phone" type="tel" 
                           placeholder="08xxxxxxxxxx">
                    <small id="visitInfo" class="visit-info">Jumlah kunjungan: -</small>
                </div>
            </div>

            <!-- Services Selection -->
            <div class="card">
                <h3>Pilih Layanan</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Layanan</th>
                            <th>Harga</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in services %}
                        <tr>
                            <td>{{ s.name }}</td>
                            <td>Rp {{ "{:,}".format(s.price) }}</td>
                            <td>
                                <input type="hidden" name="service_id" value="{{ s.id }}">
                                <div class="qty-wrap" data-price="{{ s.price }}">
                                    <button type="button" class="qty-btn" onclick="decQty(this)">âˆ’</button>
                                    <input class="qty-input" type="number" min="0" name="qty" value="0" readonly>
                                    <button type="button" class="qty-btn" onclick="incQty(this)">+</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Payment Information -->
            <div class="card">
                <h3>Informasi Pembayaran</h3>
                
                <div class="form-group">
                    <label for="payType">Tipe Pembayaran</label>
                    <select name="payment_type" id="payType" onchange="toggleCash()">
                        <option value="cash">Cash</option>
                        <option value="qris">QRIS</option>
                    </select>
                </div>
                
                <div id="cashWrap">
                    <div class="form-group">
                        <label for="cashGiven">Jumlah Dibayarkan</label>
                        <input type="number" name="cash_given" id="cashGiven" min="0" 
                               placeholder="Masukkan jumlah pembayaran">
                        <span id="cashError" class="error-message">Jumlah yang dibayarkan masih kurang dari total</span>
                    </div>
                </div>

                <div class="total-display">
                    <div class="total-amount">
                        <strong>Total: Rp <span id="total">0</span></strong>
                    </div>
                    <div id="changeWrap">
                        <strong>Kembalian: Rp <span id="change">0</span></strong>
                    </div>
                </div>
            </div>

            <button type="submit" id="submitBtn" disabled>ðŸ’¾ Simpan & Unduh Nota</button>
        </form>
    </div>
</div>

<script type="text/javascript">
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Hide all error messages initially
        document.getElementById('nameError').style.display = 'none';
        document.getElementById('emailError').style.display = 'none';
        document.getElementById('cashError').style.display = 'none';
        
        toggleCash();
        recalc();
    });

    function getQtyWraps() {
        return Array.from(document.querySelectorAll('.qty-wrap'));
    }

    function incQty(btn) {
        const wrap = btn.closest('.qty-wrap');
        const input = wrap.querySelector('.qty-input');
        const currentValue = parseInt(input.value) || 0;
        input.value = currentValue + 1;
        recalc();
    }

    function decQty(btn) {
        const wrap = btn.closest('.qty-wrap');
        const input = wrap.querySelector('.qty-input');
        const currentValue = parseInt(input.value) || 0;
        input.value = Math.max(0, currentValue - 1);
        recalc();
    }

    function totalCalc() {
        let total = 0;
        getQtyWraps().forEach(wrap => {
            const price = parseInt(wrap.dataset.price) || 0;
            const qtyInput = wrap.querySelector('.qty-input');
            const qty = parseInt(qtyInput.value) || 0;
            if (qty > 0) {
                total += price * qty;
            }
        });
        return total;
    }

    function getCustomerVisits() {
        const phone = document.getElementById('customer_phone').value.trim();
        const visitInfo = document.getElementById('visitInfo');
        
        if (phone && phone.length >= 8) {
            fetch(`/sales/customer-visits?phone=${encodeURIComponent(phone)}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    if (data.visits > 0) {
                        visitInfo.textContent = `Jumlah kunjungan: ${data.visits}`;
                        visitInfo.style.color = 'green';
                    } else {
                        visitInfo.textContent = 'Pelanggan baru';
                        visitInfo.style.color = 'blue';
                    }
                })
                .catch(error => {
                    console.error('Error fetching visits:', error);
                    visitInfo.textContent = 'Jumlah kunjungan: -';
                    visitInfo.style.color = '#6b7280';
                });
        } else {
            visitInfo.textContent = 'Jumlah kunjungan: -';
            visitInfo.style.color = '#6b7280';
        }
    }

    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function recalc() {
        const total = totalCalc();
        document.getElementById('total').textContent = total.toLocaleString('id-ID');

        const payType = document.getElementById('payType').value;
        const submitBtn = document.getElementById('submitBtn');
        const nameVal = document.getElementById('customer_name').value.trim();
        const emailVal = document.getElementById('customer_email').value.trim();

        let isValid = true;

        // Validasi nama pelanggan (wajib)
        const nameError = document.getElementById('nameError');
        if (!nameVal) {
            nameError.style.display = 'block';
            nameError.textContent = 'Nama pelanggan harus diisi';
            isValid = false;
        } else {
            nameError.style.display = 'none';
        }

        // Validasi email (opsional, tapi jika diisi harus valid)
        const emailError = document.getElementById('emailError');
        if (emailVal) {
            if (!validateEmail(emailVal)) {
                emailError.style.display = 'block';
                emailError.textContent = 'Format email tidak valid. Contoh: nama@email.com';
                isValid = false;
            } else {
                emailError.style.display = 'none';
            }
        } else {
            emailError.style.display = 'none';
        }

        // Validasi cash payment
        const cashError = document.getElementById('cashError');
        const changeWrap = document.getElementById('changeWrap');
        
        if (payType === 'cash') {
            const cashGiven = parseInt(document.getElementById('cashGiven').value) || 0;
            const change = cashGiven - total;
            
            document.getElementById('change').textContent = Math.max(0, change).toLocaleString('id-ID');
            
            if (cashGiven <= 0) {
                cashError.style.display = 'block';
                cashError.textContent = 'Jumlah pembayaran harus diisi';
                isValid = false;
            } else if (cashGiven < total) {
                cashError.style.display = 'block';
                cashError.textContent = `Jumlah yang dibayarkan kurang dari total (Rp ${total.toLocaleString('id-ID')})`;
                isValid = false;
            } else {
                cashError.style.display = 'none';
            }
            changeWrap.style.display = 'block';
        } else {
            cashError.style.display = 'none';
            changeWrap.style.display = 'none';
        }

        // Validasi minimal 1 layanan dipilih
        if (total === 0) {
            isValid = false;
        }

        // Enable/disable submit button
        submitBtn.disabled = !isValid;
        
        // Visual feedback untuk button
        if (isValid) {
            submitBtn.style.backgroundColor = '#111827';
            submitBtn.style.cursor = 'pointer';
        } else {
            submitBtn.style.backgroundColor = '#9ca3af';
            submitBtn.style.cursor = 'not-allowed';
        }
    }

    function toggleCash() {
        const payType = document.getElementById('payType').value;
        const cashWrap = document.getElementById('cashWrap');
        const changeWrap = document.getElementById('changeWrap');
        
        if (payType === 'cash') {
            cashWrap.style.display = 'block';
            changeWrap.style.display = 'block';
        } else {
            cashWrap.style.display = 'none';
            changeWrap.style.display = 'none';
            // Reset cash field when not cash payment
            document.getElementById('cashGiven').value = '';
        }
        recalc();
    }

    // Real-time validation
    document.getElementById('customer_name').addEventListener('input', recalc);
    document.getElementById('customer_email').addEventListener('input', recalc);
    document.getElementById('customer_phone').addEventListener('input', function() {
        getCustomerVisits();
    });
    document.getElementById('cashGiven').addEventListener('input', recalc);
    
    // Validasi saat form submit (additional safety)
    document.getElementById('saleForm').addEventListener('submit', function(e) {
        recalc();
        if (document.getElementById('submitBtn').disabled) {
            e.preventDefault();
            alert('Harap perbaiki error sebelum melanjutkan.');
        }
    });
</script>
{% endblock %}