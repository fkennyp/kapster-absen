{% extends 'base.html' %}

{% block title %}{{ 'Edit Transaksi' if transaction else 'Detail Transaksi' }}{% endblock %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/transaction-detail.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>{{ 'Edit Transaksi' if transaction else 'Detail Transaksi' }}</h1>
        <div class="page-header-actions">
            <a href="{{ url_for('admin.transactions_list', start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), user_id=request.args.get('user_id'), page=request.args.get('page', 1)) }}" class="btn">Kembali</a>
            {% if not edit_mode %}
            <a href="{{ url_for('admin.transaction_edit', transaction_id=transaction.id) }}"
                class="btn btn-primary">Edit Transaksi</a>
            <form action="{{ url_for('admin.transaction_delete', transaction_id=transaction.id) }}"
                method="post" style="display: inline-block;"
                onsubmit="return confirm('Anda yakin ingin menghapus transaksi ini? Aksi ini tidak dapat dibatalkan.');">
                <button type="submit" class="btn btn-danger">Hapus Transaksi</button>
            </form>
            {% endif %}
        </div>
    </div>

    <div class="card">
        {% if edit_mode %}

        <form method="post" class="form-vertical">
            <div class="form-group">
                <label>No. Invoice</label>
                <input type="text" value="{{ transaction.invoice_code }}" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Tanggal</label>
                <input type="text" value="{{ transaction.created_at.strftime('%d/%m/%Y %H:%M') }}" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="customer_name">Nama Pelanggan</label>
                <input type="text" id="customer_name" name="customer_name" class="form-control" value="{{ transaction.customer_name }}" required>
            </div>
            <div class="form-group">
                <label for="barber_name">Nama Kapster</label>
                <select id="barber_name" name="barber_name" class="form-control" required>
                    {% for user in users %}
                    <option value="{{ user.name }}" {% if user.name==transaction.barber_name %}selected{% endif %}>{{ user.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="payment_type">Jenis Pembayaran</label>
                <select id="payment_type" name="payment_type" class="form-control" required>
                    <option value="cash" {% if transaction.payment_type=='cash' %}selected{% endif %}>Cash</option>
                    <option value="qris" {% if transaction.payment_type=='qris' %}selected{% endif %}>QRIS</option>
                </select>
            </div>
            <div class="form-group">
                <label for="subtotal">Subtotal</label>
                <input type="text" value="Rp {{ '{:,'.format((transaction.total or 0) + (transaction.discount or 0)) }}" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="discount">Diskon</label>
                <input type="text" value="Rp {{ '{:,'.format(transaction.discount or 0) }}" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="total">Total Setelah Diskon</label>
                <input type="text" value="Rp {{ '{:,'.format(transaction.total or 0) }}" class="form-control" readonly>
            </div>
            <div class="form-group" id="cash-row" style="display: {% if transaction.payment_type == 'cash' %}block{% else %}none{% endif %};">
                <label for="cash_given">Uang Diterima</label>
                <input type="number" id="cash_given" name="cash_given" class="form-control" value="{{ transaction.cash_given }}" min="{{ transaction.total }}">
            </div>
            <div class="form-group" id="change-row" style="display: {% if transaction.payment_type == 'cash' %}block{% else %}none{% endif %};">
                <label for="change_amount">Kembalian</label>
                <input type="text" value="Rp {{ '{:,}'.format(transaction.change_amount or 0) }}" class="form-control" readonly>
            </div>

            <script>
            document.addEventListener('DOMContentLoaded', function() {
                var paymentType = document.getElementById('payment_type');
                var cashRow = document.getElementById('cash-row');
                function toggleCashRow() {
                    if (paymentType.value === 'cash') {
                        cashRow.style.display = 'flex';
                    } else {
                        cashRow.style.display = 'none';
                    }
                }
                paymentType.addEventListener('change', toggleCashRow);
                toggleCashRow();
            });
            </script>

            <h3>Detail Layanan</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Layanan</th>
                        <th>Harga</th>
                        <th>Jumlah</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in transaction.items %}
                    <tr>
                        <td>{{ item.service.name }}</td>
                        <td>Rp {{ "{:,}".format(item.price_each) }}</td>
                        <td>{{ item.qty }}</td>
                        <td>Rp {{ "{:,}".format(item.line_total) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-right">Subtotal:</th>
                        <th>Rp {{ '{:,}'.format((transaction.total or 0) + (transaction.discount or 0)) }}</th>
                    </tr>
                    <tr>
                        <th colspan="3" class="text-right">Diskon:</th>
                        <th>Rp {{ '{:,}'.format(transaction.discount or 0) }}</th>
                    </tr>
                    <tr>
                        <th colspan="3" class="text-right">Total Setelah Diskon:</th>
                        <th>Rp {{ '{:,}'.format(transaction.total or 0) }}</th>
                    </tr>
                </tfoot>
            </table>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                <a href="{{ url_for('admin.transactions_list', start_date=request.args.get('start_date'), end_date=request.args.get('end_date'), user_id=request.args.get('user_id'), page=request.args.get('page', 1)) }}" class="btn">Batal</a>
            </div>
        </form>
        {% else %}
        <!-- View Mode -->
        <div class="details-grid">
            <div class="detail-grid">
                <div class="detail-left">
                    <label>No. Invoice</label>
                    <div>{{ transaction.invoice_code }}</div>
                </div>
                <div class="detail-right">
                    <label>Tanggal</label>
                    <div>{{ transaction.created_at.strftime('%d/%m/%Y %H:%M') }}</div>
                </div>

                <div class="detail-left">
                    <label>Pelanggan</label>
                    <div>{{ transaction.customer_name }}</div>
                </div>
                <div class="detail-right">
                    <label>No. HP</label>
                    <div>{{ transaction.customer.phone or '-' }}</div>
                </div>

                <div class="detail-left">
                    <label>Kapster</label>
                    <div>{{ transaction.barber_name }}</div>
                </div>
                <div class="detail-right">
                    <label>Pembayaran</label>
                    <div>{{ transaction.payment_type|upper }}</div>
                </div>

                <div class="detail-left">
                    <label>Subtotal</label>
                    <div>Rp {{ "{:,}".format((transaction.total or 0) + (transaction.discount or 0)) }}</div>
                </div>
                <div class="detail-right">
                    <label>Diskon</label>
                    <div>Rp {{ "{:,}".format(transaction.discount or 0) }}</div>
                </div>
                <div class="detail-left">
                    <label>Total Setelah Diskon</label>
                    <div>Rp {{ "{:,}".format(transaction.total or 0) }}</div>
                </div>
                {% if transaction.payment_type == 'cash' %}
                <div class="detail-right">
                    <label>Uang Diterima</label>
                    <div>Rp {{ "{:,}".format(transaction.cash_given) }}</div>
                </div>

                <div class="detail-left">
                    <label>Kembalian</label>
                    <div>Rp {{ "{:,}".format(transaction.change_amount) }}</div>
                </div>
                {% endif %}
            </div>

            <h3>Detail Layanan</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Layanan</th>
                        <th>Harga</th>
                        <th>Jumlah</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in transaction.items %}
                    <tr>
                        <td>{{ item.service.name }}</td>
                        <td>Rp {{ "{:,}".format(item.price_each) }}</td>
                        <td>{{ item.qty }}</td>
                        <td>Rp {{ "{:,}".format(item.line_total) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-right">Total:</th>
                        <th>Rp {{ "{:,}".format(transaction.total) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}